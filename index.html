<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Column-Addition Quiz (Drag the Digits)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{--cell:108px;--cInd:#4338ca;--cLav:#ecebff;--cGood:#bbf7d0;--cBad:#f9a8d4}
*{box-sizing:border-box;margin:0}
html,body{height:100%}
body{
  display:flex;flex-direction:column;align-items:center;
  font-family:system-ui,Arial,sans-serif;background:var(--cLav);color:#312e81;
  overflow:hidden; -webkit-tap-highlight-color:transparent;
}
h1{margin:16px 0 4px;font-size:2.4rem}
#hud{margin-bottom:6px;font-size:1.25rem;display:flex;gap:1.4rem;flex-wrap:wrap;justify-content:center}
.main{
  flex:1 0 auto;display:flex;flex-direction:column;align-items:center;gap:1rem;
  padding-bottom:68px; /* will be adjusted dynamically by JS */
  max-width:100vw;
  padding-left:env(safe-area-inset-left);padding-right:env(safe-area-inset-right);
  padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom);
}

/* question bar */
#qbar{display:flex;align-items:center;gap:10px;margin-bottom:26px}
.qbox{width:var(--cell);height:var(--cell);border:4px solid var(--cInd);display:flex;align-items:center;justify-content:center;
      font-size:calc(var(--cell)*0.40);user-select:none;background:#fff}
.qbox.digit{cursor:grab;touch-action:none}
.qbox.digit:active{cursor:grabbing}
.qdot{border:none;font-size:calc(var(--cell)*0.60);background:transparent;width:auto}
.qplus{background:#fff;font-weight:700;font-size:calc(var(--cell)*0.60);border:none;width:auto;padding:0 6px}

/* grid */
table{border-collapse:collapse;max-width:100vw}
th,td{width:var(--cell);height:var(--cell);border:4px solid var(--cInd);text-align:center;vertical-align:middle;position:relative;overflow:hidden}
th{background:#dbeafe;font-size:calc(var(--cell)*0.14)}
.decCell{background:#fef3c7;font-weight:700}
.drop{background:#f1f5f9}
.drop.filled{background:#fff;font-size:calc(var(--cell)*0.50)}
.drop.right{background:var(--cGood)!important}
.drop.wrong{background:var(--cBad)!important}
/* hover cue for touch/pen drag */
.drop.hover{outline:3px dashed var(--cInd);outline-offset:-3px}

input.digit{width:100%;height:100%;border:none;background:#fff;color:#dc2626;font-size:calc(var(--cell)*0.50);text-align:center;
            outline:4px solid transparent}
input.digit:focus{outline:4px solid var(--cInd)}
input.digit.right{background:var(--cGood)}
input.digit.wrong{background:var(--cBad)}
input.carry{
  position:absolute;
  bottom:calc(var(--cell)*0.08);right:calc(var(--cell)*0.08);
  width:calc(var(--cell)*0.26);height:calc(var(--cell)*0.26);
  font-size:calc(var(--cell)*0.20);
  text-align:center;border:2px solid var(--cInd);border-radius:4px;background:#fff;
}

/* header pictures */
.hdr-cell{position:relative;padding:0}
.hdr-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center;z-index:0}
.hdr-label{position:relative;z-index:1;background:rgba(255,255,255,.7);padding:2px 4px;border-radius:4px}

/* buttons */
.controls{
  position:fixed;bottom:14px;left:50%;transform:translateX(-50%);display:flex;gap:18px;flex-wrap:wrap;z-index:2
}
button{padding:12px 34px;font-size:1.1rem;border:none;border-radius:10px;font-weight:600;cursor:pointer}
#checkBtn{background:#4f46e5;color:#fff}
#newBtn{background:#e2e8f0}

/* overlay */
#overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:100}
.card{background:#fff;border-radius:12px;padding:24px;display:flex;flex-direction:column;gap:14px;width:340px}
.card label{font-weight:600}.hidden{display:none}

/* flash */
@keyframes flashRed{0%{background:rgba(255,0,0,.25)}100%{background:transparent}}
body.flash{animation:flashRed .35s ease-out}

/* compact mode when space is very tight */
body.compact h1{margin:8px 0 2px;font-size:1.75rem}
body.compact #hud{gap:.8rem;font-size:1rem}
body.compact #qbar{gap:8px;margin-bottom:12px}
body.compact .controls button{padding:8px 18px;font-size:.95rem}
</style>
</head>
<body>

<!-- overlay -------------------------------------------------------- -->
<div id="overlay">
  <div class="card">
    <h2 style="text-align:center">Start Quiz</h2>
    <label>Name</label><input id="nameInput" placeholder="Your name">
    <label>Mode</label>
    <label><input type="radio" name="mode" value="timed" checked> Timed</label>
    <label><input type="radio" name="mode" value="target"> Target score</label>

    <div id="timeOpts" style="display:flex;flex-direction:column;gap:4px;margin-left:12px">
      <label><input type="radio" name="timer" value="300"> 5 min</label>
      <label><input type="radio" name="timer" value="600" checked> 10 min</label>
      <label><input type="radio" name="timer" value="900"> 15 min</label>
    </div>

    <div id="goalOpt" class="hidden" style="display:flex;flex-direction:column;gap:6px">
      <label>Target score</label><input id="goalInput" type="number" min="1" placeholder="e.g. 20">
    </div>

    <button id="startBtn" style="background:#16a34a;color:#fff;border:none;padding:10px;border-radius:8px">Start</button>
  </div>
</div>

<h1>Decimal Column Addition</h1>
<div id="hud">
  <span id="hudName"></span>
  <span id="hudScore">Score 0</span>
  <span id="hudTimer" class="hidden">Time <span id="timer">0:00</span></span>
  <span id="hudGoal"  class="hidden">Goal <span id="goalLabel"></span></span>
</div>

<div class="main">
  <div id="qbar"></div>
  <div id="grid"></div>
</div>

<div class="controls">
  <button id="checkBtn">Check</button>
  <button id="newBtn">New Problem</button>
</div>

<script>
/* ---------------------------------------------------------------
   1) FIT EVERYTHING ON ONE SCREEN + reserve space for buttons
---------------------------------------------------------------- */
function reserveForButtons(){
  const main = document.querySelector('.main');
  const ctrls = document.querySelector('.controls');
  const h = ctrls ? Math.ceil(ctrls.getBoundingClientRect().height) : 0;
  main.style.paddingBottom = (h + 24) + 'px'; // keep table clear of buttons
}

function fitEverything(){
  reserveForButtons();

  const MIN = 28, MAX = 108, STEP = 2;
  let cell = MAX;
  const root = document.documentElement;
  const body = document.body;

  body.classList.remove('compact');
  body.style.transform = '';
  body.style.transformOrigin = '';

  while (cell >= MIN){
    root.style.setProperty('--cell', cell + 'px');
    void root.offsetHeight; // reflow
    if (body.scrollHeight <= window.innerHeight &&
        body.scrollWidth  <= window.innerWidth) break;
    cell -= STEP;
  }
  if (cell <= 44) body.classList.add('compact');

  // Last-resort scaling (only after overlay is hidden)
  const overlayVisible = getComputedStyle(document.getElementById('overlay')).display !== 'none';
  if (!overlayVisible && (body.scrollHeight > window.innerHeight || body.scrollWidth > window.innerWidth)){
    const scale = Math.min(window.innerWidth / body.scrollWidth, window.innerHeight / body.scrollHeight);
    body.style.transformOrigin = 'top center';
    body.style.transform = `scale(${Math.max(0.85, Math.min(1, scale))})`;
  }
}
window.addEventListener('load',   fitEverything);
window.addEventListener('resize', fitEverything);

/* money images ----------------------------------------------------- */
const TEN_NOTE_URL = "https://greatbritishzinedotcodotuk.wordpress.com/wp-content/uploads/2016/02/10-pound-note-series-e-revision-1993-front.jpg";
const ONE_COIN_URL = "https://www.royalmint.com/globalassets/the-royal-mint/images/pages/new-pound-coin/large_new_pound.png";
const TEN_P_URL    = "https://www.checkyourchange.co.uk/wp-content/uploads/2015/03/10p1992rev.jpg";
const ONE_P_URL    = "https://www.leftovercurrency.com/app/uploads/2016/11/1-penny-coin-great-britain-obverse-1.jpg";

/* helpers & state -------------------------------------------------- */
const $   = id => document.getElementById(id);
const rnd = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const confetti = window.confetti;

let A=0,B=0,score=0,name='Player';
let mode='timed',timeLeft=0,timer=null,goal=null;

/* overlay logic ---------------------------------------------------- */
[...document.querySelectorAll('input[name="mode"]')]
  .forEach(r=>r.onchange=()=>toggleMode(r.value));
function toggleMode(v){
  $('timeOpts').classList.toggle('hidden',v!=='timed');
  $('goalOpt').classList.toggle('hidden',v!=='target');
}
toggleMode('timed');

$('startBtn').onclick=()=>{
  name=$('nameInput').value.trim()||'Player';
  mode=document.querySelector('input[name="mode"]:checked').value;
  score=0;updateScore();$('hudName').textContent=`ðŸ‘¤ ${name}`;

  if(mode==='timed'){
    timeLeft=parseInt(document.querySelector('input[name="timer"]:checked').value,10);
    $('hudTimer').classList.remove('hidden');
    $('hudGoal').classList.add('hidden');
    startTimer();
  }else{
    goal=parseInt($('goalInput').value,10)||0;
    $('goalLabel').textContent=goal;
    $('hudGoal').classList.remove('hidden');
    $('hudTimer').classList.add('hidden');
    clearInterval(timer);$('timer').textContent='âˆž';
  }
  $('overlay').style.display='none';
  newProblem();
};

/* timer ------------------------------------------------------------ */
function startTimer(){
  clearInterval(timer);tick();
  timer=setInterval(tick,1000);
  function tick(){
    $('timer').textContent=
      `${Math.floor(timeLeft/60)}:${String(timeLeft%60).padStart(2,'0')}`;
    if(timeLeft--<=0)endQuiz("â° Time's up!");
  }
}

/* digit helpers ---------------------------------------------------- */
const toDigits4=n=>String(n).padStart(4,'0').split('').map(Number);  // [T,O,t,h]

/* build draggable bar ---------------------------------------------- */
function buildQBar(){
  const bar=$('qbar');bar.innerHTML='';
  renderNum(toDigits4(A),'a');
  bar.appendChild(symbol('+','qplus'));
  renderNum(toDigits4(B),'b');

  function renderNum([T,O,t,h],row){
    const segs=[];
    if(T!==0)segs.push({val:T,col:0});
    segs.push({val:O,col:1});
    segs.push({dot:true});
    segs.push({val:t,col:3});
    segs.push({val:h,col:4});

    segs.forEach(s=>{
      if(s.dot){bar.appendChild(symbol('Â·','qdot'));return;}
      const d=document.createElement('div');
      d.className='qbox digit';d.textContent=s.val;d.draggable=true;
      d.dataset.row=row;d.dataset.col=s.col;d.dataset.val=s.val;
      // Desktop HTML5 drag:
      d.ondragstart=e=>e.dataTransfer.setData('text/plain',
        JSON.stringify({row,col:s.col,val:s.val}));
      // Touch/Pen pointer fallback:
      d.addEventListener('pointerdown',startPointerDrag,{passive:false});
      bar.appendChild(d);
    });
  }
  function symbol(ch,cls){const d=document.createElement('div');
    d.className=`qbox ${cls}`;d.textContent=ch;return d;}
}

/* build grid ------------------------------------------------------- */
function buildGrid(){
  const tbl=document.createElement('table');
  tbl.appendChild(labelRow(['Tens','Ones','â€¢','Tenths','Hundredths']));
  tbl.appendChild(dropRow('a'));
  tbl.appendChild(dropRow('b'));
  tbl.appendChild(answerRow());
  $('grid').innerHTML='';$('grid').appendChild(tbl);

  /* header */
  function labelRow(arr){
    const tr=document.createElement('tr');
    arr.forEach((txt,i)=>{
      const th=document.createElement('th');
      let url=null;
      if(i===0) url=TEN_NOTE_URL;
      if(i===1) url=ONE_COIN_URL;
      if(i===3) url=TEN_P_URL;
      if(i===4) url=ONE_P_URL;

      if(url){
        th.classList.add('hdr-cell');
        const img=document.createElement('img');
        img.className='hdr-img';img.src=url;img.alt=txt;
        const span=document.createElement('span');
        span.className='hdr-label';span.textContent=txt;
        th.append(img,span);
      }else th.textContent=txt;

      if(i===2)th.classList.add('decCell');
      tr.appendChild(th);
    });
    return tr;
  }

  /* rows for A and B */
  function dropRow(r){
    const tr=document.createElement('tr');
    for(let c=0;c<5;c++){
      const td=document.createElement('td');
      if(c===2){td.textContent='Â·';td.className='decCell';}
      else{
        td.className='drop';td.dataset.row=r;td.dataset.col=c;
        td.ondragover=e=>e.preventDefault();
        td.ondrop=handleDrop;
      }
      tr.appendChild(td);
    }
    return tr;
  }

  /* answer row */
  function answerRow(){
    const tr=document.createElement('tr');
    for(let c=0;c<5;c++){
      const td=document.createElement('td');
      if(c===2){td.textContent='Â·';td.className='decCell';}
      else{
        const inp=document.createElement('input');
        inp.className='digit';inp.maxLength=1;
        inp.oninput=()=>inp.value=inp.value.replace(/[^0-9]/g,'');
        td.appendChild(inp);
        if([0,1,3].includes(c)){
          const carry=document.createElement('input');
          carry.className='carry';carry.maxLength=1;
          carry.oninput=()=>carry.value=carry.value.replace(/[^0-9]/g,'');
          td.appendChild(carry);
        }
      }
      tr.appendChild(td);
    }
    return tr;
  }
}

/* drag handler (desktop HTML5 DnD) -------------------------------- */
function handleDrop(e){
  const data=JSON.parse(e.dataTransfer.getData('text/plain'));
  const cell=e.currentTarget;
  if(+cell.dataset.col===2)return;
  if(cell.dataset.row===data.row && cell.dataset.col===String(data.col)){
    cell.textContent=data.val;
    cell.classList.add('filled');
  }else flash(cell);
}
const flash=el=>{el.classList.add('wrong');setTimeout(()=>el.classList.remove('wrong'),350);};

/* Touch/Pen pointer drag polyfill --------------------------------- */
let dragGhost=null, hoverCell=null;
function startPointerDrag(e){
  if(e.pointerType==='mouse') return; // let mouse use native DnD
  const src=e.currentTarget;
  const row=src.dataset.row, col=src.dataset.col, val=src.dataset.val;
  e.preventDefault();

  dragGhost=src.cloneNode(true);
  Object.assign(dragGhost.style,{
    position:'fixed',left:(e.clientX - src.offsetWidth/2)+'px',top:(e.clientY - src.offsetHeight/2)+'px',
    width:getComputedStyle(src).width,height:getComputedStyle(src).height,opacity:'0.95',
    pointerEvents:'none',transform:'scale(1.05)',zIndex:'99'
  });
  document.body.appendChild(dragGhost);

  function move(ev){
    dragGhost.style.left=(ev.clientX - dragGhost.offsetWidth/2)+'px';
    dragGhost.style.top =(ev.clientY - dragGhost.offsetHeight/2)+'px';
    const t = document.elementsFromPoint(ev.clientX, ev.clientY).find(el=>el.classList && el.classList.contains('drop'));
    if(hoverCell!==t){
      if(hoverCell) hoverCell.classList.remove('hover');
      hoverCell=t;
      if(hoverCell) hoverCell.classList.add('hover');
    }
  }
  function up(){
    document.removeEventListener('pointermove',move);
    document.removeEventListener('pointerup',up,true);
    if(dragGhost){dragGhost.remove();dragGhost=null;}
    if(hoverCell){
      handleDrop({
        dataTransfer:{ getData:()=>JSON.stringify({row,col,val}) },
        currentTarget:hoverCell
      });
      hoverCell.classList.remove('hover');
      hoverCell=null;
    }
  }
  document.addEventListener('pointermove',move,{passive:false});
  document.addEventListener('pointerup',up,true);
}

/* generate numbers ------------------------------------------------- */
function randomNumberWithDigits(len){
  const slots=[0,1,2,3];
  for(let i=3;i>0;i--){const j=rnd(0,i);[slots[i],slots[j]]=[slots[j],slots[i]];}
  const digs=[0,0,0,0];
  for(let i=0;i<len;i++)digs[slots[i]]=rnd(1,9);
  return digs[0]*1000+digs[1]*100+digs[2]*10+digs[3];
}

/* new problem ------------------------------------------------------ */
function newProblem(){
  do{
    A=randomNumberWithDigits(rnd(1,4));
    B=randomNumberWithDigits(rnd(1,4));
  }while(A+B>=10000);
  buildQBar();
  buildGrid();
  document.querySelectorAll('.right,.wrong').forEach(el=>el.classList.remove('right','wrong'));
  fitEverything(); // ensure it still fits and buttons don't overlap
}

/* score & feedback ------------------------------------------------- */
const updateScore=()=>$('hudScore').textContent=`Score ${score}`;
const yay=()=>confetti({particleCount:130,spread:75,origin:{y:0.25}});
const nay=()=>{document.body.classList.add('flash');setTimeout(()=>document.body.classList.remove('flash'),350);};

/* check answer ----------------------------------------------------- */
$('checkBtn').onclick=()=>{
  let ok=true;
  const want=toDigits4(A+B);

  /* check placements */
  document.querySelectorAll('.drop').forEach(cell=>{
    const idx=+cell.dataset.col;
    if(idx===2)return;
    const src=(cell.dataset.row==='a'?toDigits4(A):toDigits4(B));
    const exp=idx<2?src[idx]:src[idx-1];
    const got=cell.textContent||'0';
    if(got==exp)mark(cell,true);else{mark(cell,false);ok=false;}
  });

  /* check answer digits */
  [...document.querySelectorAll('input.digit')].forEach((inp,i)=>{
    if((inp.value||'0')==want[i])mark(inp,true);else{mark(inp,false);ok=false;}
  });

  if(ok){
    score++;updateScore();yay();newProblem();
    if(mode==='target'&&score>=goal)endQuiz('ðŸŽ‰ Goal reached!');
  }else{
    score=Math.max(0,score-1);updateScore();nay();
  }
  function mark(el,g){el.classList.toggle('right',g);el.classList.toggle('wrong',!g);}
};

/* finish ----------------------------------------------------------- */
const endQuiz=msg=>{alert(`${msg}\nFinal score: ${score}`);location.reload()};

/* hook up the "New Problem" button */
$('newBtn').addEventListener('click',newProblem);

/* initial layout tune --------------------------------------------- */
reserveForButtons();
</script>
</body>
</html>
